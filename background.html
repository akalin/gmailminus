<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="GmailAccountChecker.js"></script>
<script type="text/javascript" src="GmailChecker.js"></script>
<script>

chrome.browserAction.setBadgeBackgroundColor({color:[190, 190, 190, 230]})
chrome.browserAction.setIcon({path: "gmail_unknown.png"});
chrome.browserAction.setBadgeText({
    text: "..."
});

var checker = makeChecker();

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo) {
  if (changeInfo.url) {
    checker.onTabUpdated(changeInfo.url);
  }
});

// Called when the user clicks on the browser action.
chrome.browserAction.onClicked.addListener(function(tab) {
  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    var i = checker.findInboxTab(tabs);
    if (i != null) {
      chrome.tabs.update(tabs[i].id, {selected: true});
    } else {
      chrome.tabs.create({url: checker.getDefaultUrl()});
    }
  });
});

function updateEmailRegexp(emailRegexp) {
  checker.emailRegexp = emailRegexp;
  // TODO(akalin): Kick off check.
}

function makeChecker() {
  var handler = function() {
    updateBadge(checker.unreadCount, checker.getTooltip());
  };
  var emailRegexpText = localStorage.emailRegexp;
  var emailRegexp;
  try {
    emailRegexp = new RegExp(emailRegexpText, '');
  }
  catch(error) {
    console.warn(error);
    emailRegexp = /.*/;
  }
  var checker = new GmailChecker(emailRegexp, handler);
  return checker;
}

function updateBadge(unreadCount, tooltip) {
  if (unreadCount == null) {
    chrome.browserAction.setBadgeText({
      text: "?"
    });
    chrome.browserAction.setIcon({path:"gmail_unknown.png"});
    chrome.browserAction.setBadgeBackgroundColor({color:[190, 190, 190, 230]});
  } else if (unreadCount == 0) {
    chrome.browserAction.setBadgeText({
      text: ""
    });
    chrome.browserAction.setIcon({path: "gmail_no_unread.png"});
    chrome.browserAction.setBadgeBackgroundColor({color:[208, 0, 24, 255]});
  } else {
    chrome.browserAction.setBadgeText({
      text: unreadCount.toString(10)
    });
    chrome.browserAction.setIcon({path: "gmail_unread.png"});
    chrome.browserAction.setBadgeBackgroundColor({color:[208, 0, 24, 255]});
  }
  chrome.browserAction.setTitle({title: tooltip});
}
</script>
</head>
<body></body>
</html>
